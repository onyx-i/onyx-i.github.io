<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Timer</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-sprint: #ff4757;
            --accent-sprint-dark: #ff3742;
            --accent-sprint-gradient: linear-gradient(135deg, #ff6b7a, #ff4757, #e63946);
            --accent-rest: #2ed573;
            --accent-rest-dark: #27c463;
            --accent-rest-gradient: linear-gradient(135deg, #48e085, #2ed573, #20bf6b);
            --accent-neutral: #3742fa;
            --accent-neutral-gradient: linear-gradient(135deg, #5a67d8, #3742fa, #2f3349);
            --border-color: #333;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 30px rgba(255, 71, 87, 0.3);
            --warning-glow: 0 0 40px rgba(255, 71, 87, 0.6);
        }

```
    [data-theme="light"] {
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --text-primary: #1a1a1a;
        --text-secondary: #6c757d;
        --accent-sprint: #dc3545;
        --accent-sprint-dark: #c82333;
        --accent-sprint-gradient: linear-gradient(135deg, #f56565, #dc3545, #c53030);
        --accent-rest: #28a745;
        --accent-rest-dark: #218838;
        --accent-rest-gradient: linear-gradient(135deg, #68d391, #28a745, #38a169);
        --accent-neutral: #007bff;
        --accent-neutral-gradient: linear-gradient(135deg, #4299e1, #007bff, #3182ce);
        --border-color: #dee2e6;
        --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        --shadow-glow: 0 0 30px rgba(220, 53, 69, 0.2);
        --warning-glow: 0 0 40px rgba(220, 53, 69, 0.4);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-primary);
        background-image: 
            radial-gradient(circle at 20% 50%, rgba(58, 66, 250, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(46, 213, 115, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 80%, rgba(255, 71, 87, 0.1) 0%, transparent 50%);
        color: var(--text-primary);
        height: 100vh;
        overflow: hidden;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        transition: background 0.5s ease;
    }

    body.sprint-mode {
        background-image: 
            radial-gradient(circle at 50% 50%, rgba(255, 71, 87, 0.15) 0%, transparent 70%),
            radial-gradient(circle at 20% 80%, rgba(255, 107, 122, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(230, 57, 70, 0.1) 0%, transparent 50%);
    }

    body.rest-mode {
        background-image: 
            radial-gradient(circle at 50% 50%, rgba(46, 213, 115, 0.15) 0%, transparent 70%),
            radial-gradient(circle at 20% 20%, rgba(72, 224, 133, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(32, 191, 107, 0.1) 0%, transparent 50%);
    }

    body.warning-mode {
        animation: warningPulse 1s ease-in-out infinite alternate;
    }

    @keyframes warningPulse {
        0% {
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(255, 71, 87, 0.2) 0%, transparent 60%),
                radial-gradient(circle at 20% 80%, rgba(255, 107, 122, 0.15) 0%, transparent 50%);
        }
        100% {
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(255, 71, 87, 0.4) 0%, transparent 60%),
                radial-gradient(circle at 20% 80%, rgba(255, 107, 122, 0.25) 0%, transparent 50%);
        }
    }

    .container {
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        position: relative;
        backdrop-filter: blur(1px);
    }

    .status-bar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 12px;
        background: var(--accent-neutral-gradient);
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(58, 66, 250, 0.3);
    }

    .status-bar.sprint {
        background: var(--accent-sprint-gradient);
        box-shadow: 0 4px 20px rgba(255, 71, 87, 0.4);
    }

    .status-bar.rest {
        background: var(--accent-rest-gradient);
        box-shadow: 0 4px 20px rgba(46, 213, 115, 0.4);
    }

    .status-bar.warning {
        animation: statusWarning 0.5s ease-in-out infinite alternate;
    }

    @keyframes statusWarning {
        0% {
            box-shadow: 0 4px 20px rgba(255, 71, 87, 0.4);
            height: 12px;
        }
        100% {
            box-shadow: 0 6px 30px rgba(255, 71, 87, 0.8);
            height: 16px;
        }
    }

    .header {
        position: absolute;
        top: 60px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
    }

    .mode-indicator {
        font-size: 24px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--accent-neutral);
        transition: all 0.3s ease;
    }

    .mode-indicator.sprint {
        color: var(--accent-sprint);
    }

    .mode-indicator.rest {
        color: var(--accent-rest);
    }

    .heart-rate-display {
        position: absolute;
        top: 120px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
    }

    .heart-rate-container {
        background: linear-gradient(135deg, var(--bg-secondary), #252525);
        border-radius: 16px;
        padding: 16px 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 
            0 8px 32px rgba(0, 0, 0, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateY(-20px);
    }

    .heart-rate-container.connected {
        opacity: 1;
        transform: translateY(0);
    }

    .heart-rate-container.disconnected {
        background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), rgba(255, 71, 87, 0.05));
        border-color: rgba(255, 71, 87, 0.3);
    }

    .heart-icon {
        font-size: 20px;
        color: var(--accent-sprint);
        animation: heartbeat 1.2s ease-in-out infinite;
    }

    .heart-icon.disconnected {
        animation: none;
        opacity: 0.5;
    }

    @keyframes heartbeat {
        0%, 100% { transform: scale(1); }
        25% { transform: scale(1.1); }
        50% { transform: scale(1); }
        75% { transform: scale(1.05); }
    }

    .heart-rate-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        min-width: 60px;
        text-align: center;
    }

    .heart-rate-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }

    .heart-rate-zone {
        width: 8px;
        height: 40px;
        border-radius: 4px;
        background: var(--accent-neutral);
        transition: all 0.3s ease;
    }

    .heart-rate-zone.zone-1 { background: linear-gradient(180deg, #68d391, #38a169); }
    .heart-rate-zone.zone-2 { background: linear-gradient(180deg, #4fd1c7, #319795); }
    .heart-rate-zone.zone-3 { background: linear-gradient(180deg, #fbb6ce, #ed64a6); }
    .heart-rate-zone.zone-4 { background: linear-gradient(180deg, #f6ad55, #ed8936); }
    .heart-rate-zone.zone-5 { background: linear-gradient(180deg, #fc8181, #e53e3e); }

    .controls-header {
        display: flex;
        gap: 12px;
    }

    .btn-icon {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 12px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow);
        position: relative;
    }

    .btn-icon:hover {
        transform: translateY(-2px);
    }

    .btn-icon:active {
        transform: translateY(0);
    }

    .btn-icon.bluetooth-connected {
        background: linear-gradient(135deg, var(--accent-neutral), #4c63d2);
        color: white;
        box-shadow: 0 0 20px rgba(58, 66, 250, 0.4);
    }

    .btn-icon.bluetooth-connecting {
        animation: bluetoothPulse 1s ease-in-out infinite alternate;
    }

    @keyframes bluetoothPulse {
        0% {
            background: var(--bg-secondary);
            box-shadow: var(--shadow);
        }
        100% {
            background: linear-gradient(135deg, var(--accent-neutral), #4c63d2);
            box-shadow: 0 0 20px rgba(58, 66, 250, 0.4);
        }
    }

    .timer-display {
        font-size: clamp(80px, 20vw, 160px);
        font-weight: 800;
        text-align: center;
        margin: 40px 0;
        transition: all 0.3s ease;
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
    }

    .timer-display.sprint {
        background: var(--accent-sprint-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 20px rgba(255, 71, 87, 0.5));
    }

    .timer-display.rest {
        background: var(--accent-rest-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 20px rgba(46, 213, 115, 0.5));
    }

    .timer-display.warning {
        animation: timerWarning 0.6s ease-in-out infinite alternate;
    }

    .timer-display.critical {
        animation: timerCritical 0.3s ease-in-out infinite alternate;
    }

    @keyframes timerWarning {
        0% {
            transform: scale(1);
            filter: drop-shadow(0 0 20px rgba(255, 71, 87, 0.5));
        }
        100% {
            transform: scale(1.05);
            filter: drop-shadow(0 0 40px rgba(255, 71, 87, 0.8));
        }
    }

    @keyframes timerCritical {
        0% {
            transform: scale(1.02);
            filter: drop-shadow(0 0 30px rgba(255, 71, 87, 0.7));
        }
        100% {
            transform: scale(1.08);
            filter: drop-shadow(0 0 50px rgba(255, 71, 87, 1));
        }
    }

    .progress-container {
        width: 100%;
        max-width: 400px;
        height: 12px;
        background: var(--bg-secondary);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 40px;
        box-shadow: 
            inset 0 2px 8px rgba(0, 0, 0, 0.2),
            0 4px 16px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    .progress-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, 
            transparent 0%, 
            rgba(255, 255, 255, 0.1) 50%, 
            transparent 100%);
        animation: shimmer 2s ease-in-out infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .progress-bar {
        height: 100%;
        background: var(--accent-neutral-gradient);
        transition: all 0.1s linear;
        border-radius: 8px;
        position: relative;
        box-shadow: 0 0 10px rgba(58, 66, 250, 0.4);
    }

    .progress-bar.sprint {
        background: var(--accent-sprint-gradient);
        box-shadow: 0 0 15px rgba(255, 71, 87, 0.5);
    }

    .progress-bar.rest {
        background: var(--accent-rest-gradient);
        box-shadow: 0 0 15px rgba(46, 213, 115, 0.5);
    }

    .progress-bar.warning {
        animation: progressWarning 0.5s ease-in-out infinite alternate;
    }

    .progress-bar.critical {
        animation: progressCritical 0.3s ease-in-out infinite alternate;
    }

    @keyframes progressWarning {
        0% {
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.5);
        }
        100% {
            box-shadow: 0 0 25px rgba(255, 71, 87, 0.8);
        }
    }

    @keyframes progressCritical {
        0% {
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.7);
        }
        100% {
            box-shadow: 0 0 35px rgba(255, 71, 87, 1);
        }
    }

    .controls {
        display: flex;
        gap: 20px;
        margin-bottom: 40px;
    }

    .btn {
        padding: 16px 32px;
        border: none;
        border-radius: 16px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow);
        min-width: 120px;
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transition: all 0.3s ease;
        transform: translate(-50%, -50%);
    }

    .btn:active::before {
        width: 300px;
        height: 300px;
    }

    .btn-primary {
        background: var(--accent-neutral-gradient);
        color: white;
        box-shadow: 
            0 8px 32px rgba(58, 66, 250, 0.3),
            0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .btn-secondary {
        background: linear-gradient(135deg, var(--bg-secondary), #2a2a2a);
        color: var(--text-primary);
        box-shadow: 
            0 8px 32px rgba(0, 0, 0, 0.2),
            0 4px 16px rgba(255, 255, 255, 0.05);
    }

    .btn:hover {
        transform: translateY(-3px);
        box-shadow: 
            0 12px 40px rgba(58, 66, 250, 0.4),
            0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .btn-secondary:hover {
        box-shadow: 
            0 12px 40px rgba(0, 0, 0, 0.3),
            0 6px 20px rgba(255, 255, 255, 0.1);
    }

    .btn:active {
        transform: translateY(-1px);
    }

    .session-info {
        text-align: center;
        color: var(--text-secondary);
        font-size: 16px;
        margin-bottom: 20px;
    }

    .settings-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }

    .settings-panel {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: 30px;
        max-width: 400px;
        width: 100%;
        box-shadow: var(--shadow);
    }

    .settings-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 30px;
        text-align: center;
    }

    .setting-group {
        margin-bottom: 25px;
    }

    .setting-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-secondary);
    }

    .setting-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 16px;
        transition: border-color 0.2s ease;
    }

    .setting-input:focus {
        outline: none;
        border-color: var(--accent-neutral);
    }

    .checkbox-container {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 20px;
    }

    .checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-radius: 4px;
        background: var(--bg-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .checkbox.checked {
        background: var(--accent-neutral);
        border-color: var(--accent-neutral);
    }

    .checkbox.checked::after {
        content: '‚úì';
        color: white;
        font-weight: bold;
        font-size: 14px;
    }

    .settings-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }

    .notification {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-secondary);
        color: var(--text-primary);
        padding: 20px 30px;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 600;
        box-shadow: var(--shadow);
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .notification.show {
        opacity: 1;
    }

    @media (max-width: 480px) {
        .container {
            padding: 10px;
        }
        
        .header {
            top: 40px;
            left: 10px;
            right: 10px;
        }

        .heart-rate-display {
            top: 100px;
            left: 10px;
            right: 10px;
        }

        .heart-rate-container {
            padding: 12px 20px;
            gap: 10px;
        }

        .heart-rate-value {
            font-size: 20px;
            min-width: 50px;
        }

        .heart-icon {
            font-size: 18px;
        }
        
        .mode-indicator {
            font-size: 20px;
        }
        
        .controls {
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }
        
        .btn {
            width: 100%;
        }
    }
</style>
```

</head>
<body data-theme="dark">
    <div class="container">
        <div class="status-bar" id="statusBar"></div>

```
    <div class="header">
        <div class="mode-indicator" id="modeIndicator">Ready</div>
        <div class="controls-header">
            <button class="btn-icon" id="bluetoothBtn" title="Connect WHOOP">üì∂</button>
            <button class="btn-icon" id="themeToggle" title="Toggle theme">üåô</button>
            <button class="btn-icon" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
        </div>
    </div>

    <div class="heart-rate-display">
        <div class="heart-rate-container" id="heartRateContainer">
            <div class="heart-icon" id="heartIcon">‚ù§Ô∏è</div>
            <div class="heart-rate-value" id="heartRateValue">--</div>
            <div class="heart-rate-label">BPM</div>
            <div class="heart-rate-zone" id="heartRateZone"></div>
        </div>
    </div>

    <div class="timer-display" id="timerDisplay">00:30</div>
    
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="session-info" id="sessionInfo">
        Sprint: 30s | Rest: 90s | Rounds: ‚àû
    </div>

    <div class="controls">
        <button class="btn btn-primary" id="startBtn">Start</button>
        <button class="btn btn-secondary" id="resetBtn">Reset</button>
    </div>
</div>

<div class="settings-overlay" id="settingsOverlay">
    <div class="settings-panel">
        <h2 class="settings-title">Timer Settings</h2>
        
        <div class="setting-group">
            <label class="setting-label">Sprint Duration (seconds)</label>
            <input type="number" class="setting-input" id="sprintTime" value="30" min="1" max="300">
        </div>
        
        <div class="setting-group">
            <label class="setting-label">Rest Duration (seconds)</label>
            <input type="number" class="setting-input" id="restTime" value="90" min="1" max="600">
        </div>
        
        <div class="setting-group">
            <label class="setting-label">Number of Rounds (0 = infinite)</label>
            <input type="number" class="setting-input" id="rounds" value="0" min="0" max="100">
        </div>

        <div class="checkbox-container">
            <div class="checkbox checked" id="soundToggle"></div>
            <label class="setting-label">Sound notifications</label>
        </div>

        <div class="settings-actions">
            <button class="btn btn-primary" id="saveSettings">Save</button>
            <button class="btn btn-secondary" id="cancelSettings">Cancel</button>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>

<script>
    class SprintTimer {
        constructor() {
            this.sprintDuration = 30;
            this.restDuration = 90;
            this.totalRounds = 0; // 0 = infinite
            this.soundEnabled = true;
            
            this.currentPhase = 'sprint'; // 'sprint' or 'rest'
            this.timeRemaining = this.sprintDuration;
            this.currentRound = 1;
            this.isRunning = false;
            this.intervalId = null;
            
            // Bluetooth Heart Rate
            this.bluetoothDevice = null;
            this.heartRateService = null;
            this.heartRateCharacteristic = null;
            this.isBluetoothConnected = false;
            this.currentHeartRate = 0;
            this.heartRateHistory = [];
            
            this.initElements();
            this.setupEventListeners();
            this.updateDisplay();
            this.updateSessionInfo();
            this.loadSettings();
            this.checkBluetoothSupport();
        }

        initElements() {
            this.timerDisplay = document.getElementById('timerDisplay');
            this.modeIndicator = document.getElementById('modeIndicator');
            this.statusBar = document.getElementById('statusBar');
            this.progressBar = document.getElementById('progressBar');
            this.startBtn = document.getElementById('startBtn');
            this.resetBtn = document.getElementById('resetBtn');
            this.sessionInfo = document.getElementById('sessionInfo');
            this.settingsOverlay = document.getElementById('settingsOverlay');
            this.notification = document.getElementById('notification');
            
            // Heart rate elements
            this.bluetoothBtn = document.getElementById('bluetoothBtn');
            this.heartRateContainer = document.getElementById('heartRateContainer');
            this.heartRateValue = document.getElementById('heartRateValue');
            this.heartIcon = document.getElementById('heartIcon');
            this.heartRateZone = document.getElementById('heartRateZone');
        }

        setupEventListeners() {
            document.getElementById('startBtn').addEventListener('click', () => this.toggleTimer());
            document.getElementById('resetBtn').addEventListener('click', () => this.reset());
            document.getElementById('settingsBtn').addEventListener('click', () => this.openSettings());
            document.getElementById('themeToggle').addEventListener('click', () => this.toggleTheme());
            document.getElementById('bluetoothBtn').addEventListener('click', () => this.toggleBluetooth());
            document.getElementById('saveSettings').addEventListener('click', () => this.saveSettings());
            document.getElementById('cancelSettings').addEventListener('click', () => this.closeSettings());
            document.getElementById('soundToggle').addEventListener('click', () => this.toggleSound());
            
            // Close settings when clicking overlay
            document.getElementById('settingsOverlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) this.closeSettings();
            });

            // Prevent screen sleep
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && this.isRunning) {
                    // Keep timer running in background
                }
            });
        }

        toggleTimer() {
            if (this.isRunning) {
                this.pause();
            } else {
                this.start();
            }
        }

        start() {
            this.isRunning = true;
            this.startBtn.textContent = 'Pause';
            this.startBtn.className = 'btn btn-secondary';
            
            this.intervalId = setInterval(() => {
                this.tick();
            }, 1000);
            
            this.showNotification(`${this.currentPhase === 'sprint' ? 'Sprint' : 'Rest'} started!`);
        }

        pause() {
            this.isRunning = false;
            this.startBtn.textContent = 'Start';
            this.startBtn.className = 'btn btn-primary';
            
            if (this.intervalId) {
                clearInterval(this.intervalId);
                this.intervalId = null;
            }
        }

        reset() {
            this.pause();
            this.currentPhase = 'sprint';
            this.timeRemaining = this.sprintDuration;
            this.currentRound = 1;
            
            // Clear all visual warning states
            document.body.classList.remove('warning-mode', 'sprint-mode', 'rest-mode');
            this.timerDisplay.classList.remove('warning', 'critical');
            this.progressBar.classList.remove('warning', 'critical');
            this.statusBar.classList.remove('warning');
            
            this.updateDisplay();
            this.showNotification('Timer reset');
        }

        tick() {
            this.timeRemaining--;
            
            // Play warning sounds at specific intervals
            if (this.soundEnabled && this.timeRemaining <= 5 && this.timeRemaining > 0) {
                this.playSound(1400, 0.2); // Quick beep for final countdown
            } else if (this.soundEnabled && this.timeRemaining === 10) {
                this.playSound(1000, 0.4); // Warning at 10 seconds
            }
            
            if (this.timeRemaining <= 0) {
                this.switchPhase();
            }
            
            this.updateDisplay();
        }

        switchPhase() {
            if (this.currentPhase === 'sprint') {
                this.currentPhase = 'rest';
                this.timeRemaining = this.restDuration;
                this.showNotification('Rest time!');
                this.playSound(800, 0.3); // Lower pitch for rest
            } else {
                this.currentPhase = 'sprint';
                this.timeRemaining = this.sprintDuration;
                this.currentRound++;
                
                // Check if we've completed all rounds
                if (this.totalRounds > 0 && this.currentRound > this.totalRounds) {
                    this.complete();
                    return;
                }
                
                this.showNotification('Sprint time!');
                this.playSound(1200, 0.5); // Higher pitch for sprint
            }
        }

        complete() {
            this.pause();
            this.showNotification('Workout complete! üéâ');
            this.playSound(1000, 0.7);
            setTimeout(() => this.reset(), 3000);
        }

        updateDisplay() {
            const minutes = Math.floor(this.timeRemaining / 60);
            const seconds = this.timeRemaining % 60;
            this.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update phase indicators
            this.modeIndicator.textContent = this.currentPhase === 'sprint' ? 'Sprint' : 'Rest';
            this.modeIndicator.className = `mode-indicator ${this.currentPhase}`;
            this.timerDisplay.className = `timer-display ${this.currentPhase}`;
            this.statusBar.className = `status-bar ${this.currentPhase}`;
            this.progressBar.className = `progress-bar ${this.currentPhase}`;
            
            // Add warning effects for low time
            const isWarning = this.timeRemaining <= 10 && this.timeRemaining > 5;
            const isCritical = this.timeRemaining <= 5 && this.timeRemaining > 0;
            
            if (isCritical) {
                this.timerDisplay.classList.add('critical');
                this.progressBar.classList.add('critical');
                this.statusBar.classList.add('warning');
                document.body.classList.add('warning-mode');
                document.body.classList.remove('sprint-mode', 'rest-mode');
            } else if (isWarning) {
                this.timerDisplay.classList.add('warning');
                this.progressBar.classList.add('warning');
                this.statusBar.classList.add('warning');
                document.body.classList.add('warning-mode');
                document.body.classList.remove('sprint-mode', 'rest-mode');
            } else {
                this.timerDisplay.classList.remove('warning', 'critical');
                this.progressBar.classList.remove('warning', 'critical');
                this.statusBar.classList.remove('warning');
                document.body.classList.remove('warning-mode');
                document.body.classList.add(this.currentPhase === 'sprint' ? 'sprint-mode' : 'rest-mode');
                document.body.classList.remove(this.currentPhase === 'sprint' ? 'rest-mode' : 'sprint-mode');
            }
            
            // Update progress bar
            const totalTime = this.currentPhase === 'sprint' ? this.sprintDuration : this.restDuration;
            const progress = ((totalTime - this.timeRemaining) / totalTime) * 100;
            this.progressBar.style.width = `${progress}%`;
            
            // Update session info
            this.updateSessionInfo();
        }

        updateSessionInfo() {
            const roundsText = this.totalRounds === 0 ? '‚àû' : `${this.currentRound}/${this.totalRounds}`;
            this.sessionInfo.textContent = `Sprint: ${this.sprintDuration}s | Rest: ${this.restDuration}s | Rounds: ${roundsText}`;
        }

        openSettings() {
            document.getElementById('sprintTime').value = this.sprintDuration;
            document.getElementById('restTime').value = this.restDuration;
            document.getElementById('rounds').value = this.totalRounds;
            document.getElementById('soundToggle').className = this.soundEnabled ? 'checkbox checked' : 'checkbox';
            this.settingsOverlay.style.display = 'flex';
        }

        closeSettings() {
            this.settingsOverlay.style.display = 'none';
        }

        saveSettings() {
            const newSprintTime = parseInt(document.getElementById('sprintTime').value);
            const newRestTime = parseInt(document.getElementById('restTime').value);
            const newRounds = parseInt(document.getElementById('rounds').value);
            
            if (newSprintTime > 0 && newRestTime > 0 && newRounds >= 0) {
                this.sprintDuration = newSprintTime;
                this.restDuration = newRestTime;
                this.totalRounds = newRounds;
                
                // Reset timer with new settings
                this.reset();
                this.updateDisplay();
                this.closeSettings();
                this.showNotification('Settings saved!');
                this.saveSettingsToStorage();
            }
        }

        toggleSound() {
            const toggle = document.getElementById('soundToggle');
            this.soundEnabled = !this.soundEnabled;
            toggle.className = this.soundEnabled ? 'checkbox checked' : 'checkbox';
        }

        toggleTheme() {
            const body = document.body;
            const toggle = document.getElementById('themeToggle');
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            toggle.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            
            localStorage.setItem('theme', newTheme);
        }

        playSound(frequency = 1000, duration = 0.3) {
            if (!this.soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                // Audio not supported or blocked
            }
        }

        showNotification(message) {
            this.notification.textContent = message;
            this.notification.classList.add('show');
            setTimeout(() => {
                this.notification.classList.remove('show');
            }, 2000);
        }

        saveSettingsToStorage() {
            const settings = {
                sprintDuration: this.sprintDuration,
                restDuration: this.restDuration,
                totalRounds: this.totalRounds,
                soundEnabled: this.soundEnabled
            };
            localStorage.setItem('sprintTimerSettings', JSON.stringify(settings));
        }

        // Bluetooth Heart Rate Integration
        checkBluetoothSupport() {
            if (!navigator.bluetooth) {
                this.bluetoothBtn.style.display = 'none';
                console.log('Web Bluetooth API not supported');
            }
        }

        async toggleBluetooth() {
            if (this.isBluetoothConnected) {
                await this.disconnectHeartRate();
            } else {
                await this.connectHeartRate();
            }
        }

        async connectHeartRate() {
            try {
                this.bluetoothBtn.classList.add('bluetooth-connecting');
                this.showNotification('Connecting to WHOOP...');

                // Request Bluetooth device with Heart Rate service
                this.bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['heart_rate'] },
                        { namePrefix: 'WHOOP' },
                        { namePrefix: 'Polar' },
                        { namePrefix: 'Garmin' }
                    ],
                    optionalServices: ['heart_rate']
                });

                // Add disconnect event listener
                this.bluetoothDevice.addEventListener('gattserverdisconnected', () => {
                    this.onBluetoothDisconnected();
                });

                // Connect to GATT server
                const server = await this.bluetoothDevice.gatt.connect();
                
                // Get Heart Rate service
                this.heartRateService = await server.getPrimaryService('heart_rate');
                
                // Get Heart Rate Measurement characteristic
                this.heartRateCharacteristic = await this.heartRateService.getCharacteristic('heart_rate_measurement');
                
                // Start notifications
                await this.heartRateCharacteristic.startNotifications();
                this.heartRateCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
                    this.parseHeartRateData(event.target.value);
                });

                this.onBluetoothConnected();
                this.showNotification(`Connected to ${this.bluetoothDevice.name}!`);

            } catch (error) {
                console.error('Bluetooth connection failed:', error);
                this.showNotification('Failed to connect to device');
                this.bluetoothBtn.classList.remove('bluetooth-connecting');
                
                if (error.name !== 'NotFoundError') {
                    this.showNotification('Bluetooth error: ' + error.message);
                }
            }
        }

        async disconnectHeartRate() {
            try {
                if (this.bluetoothDevice && this.bluetoothDevice.gatt.connected) {
                    await this.bluetoothDevice.gatt.disconnect();
                }
                this.onBluetoothDisconnected();
                this.showNotification('Disconnected from heart rate monitor');
            } catch (error) {
                console.error('Disconnect error:', error);
            }
        }

        onBluetoothConnected() {
            this.isBluetoothConnected = true;
            this.bluetoothBtn.classList.remove('bluetooth-connecting');
            this.bluetoothBtn.classList.add('bluetooth-connected');
            this.bluetoothBtn.textContent = 'üì°';
            this.heartRateContainer.classList.add('connected');
            this.heartRateContainer.classList.remove('disconnected');
            this.heartIcon.classList.remove('disconnected');
        }

        onBluetoothDisconnected() {
            this.isBluetoothConnected = false;
            this.bluetoothBtn.classList.remove('bluetooth-connecting', 'bluetooth-connected');
            this.bluetoothBtn.textContent = 'üì∂';
            this.heartRateContainer.classList.remove('connected');
            this.heartRateContainer.classList.add('disconnected');
            this.heartIcon.classList.add('disconnected');
            this.heartRateValue.textContent = '--';
            this.heartRateZone.className = 'heart-rate-zone';
            this.bluetoothDevice = null;
            this.heartRateService = null;
            this.heartRateCharacteristic = null;
        }

        parseHeartRateData(value) {
            // Parse heart rate data according to Bluetooth specification
            const flags = value.getUint8(0);
            let heartRate;

            if (flags & 0x01) {
                // Heart rate format is 16-bit
                heartRate = value.getUint16(1, true);
            } else {
                // Heart rate format is 8-bit
                heartRate = value.getUint8(1);
            }

            this.updateHeartRate(heartRate);
        }

        updateHeartRate(heartRate) {
            if (heartRate > 0 && heartRate < 220) { // Sanity check
                this.currentHeartRate = heartRate;
                this.heartRateValue.textContent = heartRate;
                
                // Update heart rate history (keep last 10 readings)
                this.heartRateHistory.push(heartRate);
                if (this.heartRateHistory.length > 10) {
                    this.heartRateHistory.shift();
                }
                
                // Update heart rate zone
                this.updateHeartRateZone(heartRate);
                
                // Sync heartbeat animation with actual heart rate
                this.syncHeartbeatAnimation(heartRate);
            }
        }

        updateHeartRateZone(heartRate) {
            // Basic heart rate zones (adjust based on age/fitness level)
            let zone = '';
            if (heartRate < 100) zone = 'zone-1';
            else if (heartRate < 130) zone = 'zone-2';
            else if (heartRate < 150) zone = 'zone-3';
            else if (heartRate < 170) zone = 'zone-4';
            else zone = 'zone-5';
            
            this.heartRateZone.className = `heart-rate-zone ${zone}`;
        }

        syncHeartbeatAnimation(heartRate) {
            // Adjust heartbeat animation speed based on actual heart rate
            const bpm = Math.max(60, Math.min(180, heartRate)); // Clamp between 60-180
            const duration = 60 / bpm; // Duration in seconds per beat
            
            this.heartIcon.style.animationDuration = `${duration}s`;
        }

        loadSettings() {
            const saved = localStorage.getItem('sprintTimerSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                this.sprintDuration = settings.sprintDuration || 30;
                this.restDuration = settings.restDuration || 90;
                this.totalRounds = settings.totalRounds || 0;
                this.soundEnabled = settings.soundEnabled !== false;
                this.timeRemaining = this.sprintDuration;
                this.updateDisplay();
            }

            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('themeToggle').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }
    }

    // Initialize the timer when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        new SprintTimer();
    });

    // Prevent context menu on long press (mobile)
    document.addEventListener('contextmenu', e => e.preventDefault());
    
    // Keep screen awake (request)
    if ('wakeLock' in navigator) {
        let wakeLock = null;
        const requestWakeLock = async () => {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
            } catch (err) {
                // Wake lock not supported or failed
            }
        };
        
        document.addEventListener('visibilitychange', () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                requestWakeLock();
            }
        });
        
        requestWakeLock();
    }
</script>
```

</body>
</html>